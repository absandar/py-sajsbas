{% extends 'base.html' %}

{% block title %}Reportes{% endblock %}

{% block content %}
<style>
    table {
        color: black;
    }
</style>
<h2 style="margin: 5px 0 0 0;">Reportes</h2>

<div id="reportes"></div>
<div id="modalDetallesLote" class="modal-overlay">
    <div class="modal-box">

        <div class="modal-header">
            <h3>Detalles del lote</h3>
            <span class="modal-close" onclick="cerrarModal()">&times;</span>
        </div>

        <div id="modalContenidoLote" class="modal-body">
            Cargando datos...
        </div>

    </div>
</div>

<style>
    h3 {
        margin: 0;
    }

    .modal-overlay {
        display: none;
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
    }

    .modal-box {
        background: white;
        width: 97%;
        max-height: 100vh;
        border-radius: 6px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        background: #333;
        color: white;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 6px;
        overflow-y: auto;
        max-height: 99vh;
    }

    .modal-close {
        cursor: pointer;
        font-size: 24px;
        padding: 0 10px;
    }
</style>

<script>
    fetch('/toda_la_data_de_local')
        .then((res) => res.ok ? res.json() : null)
        .then((data) => {
            const tallas = data.tallas;
            const contenedor = document.getElementById("reportes");

            // Colores pastel para cada lote
            const coloresPastel = [
                "#FFD1DC", "#C1E1C1", "#FFE4B5", "#B0E0E6", "#E6E6FA", "#FFBD5E", "#D3B1F9", "#82B2C0", "#F6C7B3", "#CED1F8"
            ];

            let html = "<h3>Detalle por Lote</h3>";
            let indexColor = 0;
            for (const [lote, info] of Object.entries(data.detalle_por_lote)) {
                const colorTabla = coloresPastel[Math.floor(Math.random() * coloresPastel.length)];
                indexColor++;

                html += `<table data-lote="${lote}" border='1' cellpadding='5' cellspacing='0' 
                        style='background:${colorTabla}; border-collapse: collapse;'>`;

                // --- Primera fila: nombre del lote ---
                html += `<tr style="font-weight:bold; background:#ffffff;"><td colspan="${info.dias.length + 1}">Lote: ${lote}</td></tr>`;

                // --- Encabezados ---
                html += "<tr style='background:#ffffff;'><th>Talla</th>";
                info.dias.forEach(dia => {
                    html += `<th>${dia}</th>`;
                });
                html += "<th>Total General</th>"; // <- Agregar columna para el total
                html += "</tr>";

                // Totales por d√≠a
                let totales = {};
                info.dias.forEach(d => totales[d] = 0);  // <-- define antes de las filas

                // --- Filas de tallas ---
                info.tabla.forEach((fila, idx) => {
                    const filaColor = idx % 2 === 0 ? "rgba(255,255,255,0.1)" : "rgba(255,255,255,0.3)";
                    html += `<tr style="background:${filaColor}">`;
                    html += `<td>${tallas[fila.talla]}</td>`;
                    info.dias.forEach(dia => {
                        const valor = fila[dia];
                        const valorFormateado = (valor === 0 || valor === null || valor === '')
                            ? '‚Äì'
                            : valor.toLocaleString('es-MX', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                        html += `<td>${valorFormateado}</td>`;
                        totales[dia] += valor;
                    });
                    html += `<td></td>`; // celda extra vac√≠a al final
                    html += "</tr>";
                });

                // --- Fila de Total final ---
                html += `<tr style='font-weight:bold; background:#ffffff;'><td>Totales</td>`;
                info.dias.forEach(dia => {
                    const valor = totales[dia];
                    const valorFormateado = (valor === 0 || valor === null || valor === '')
                        ? '‚Äì'
                        : valor.toLocaleString('es-MX', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    html += `<td>${valorFormateado}</td>`;
                });
                const totalLote = data.totales_por_lote.find(t => t.lote === lote)?.total_peso_neto ?? 0;
                const totalLoteFormateado = totalLote.toLocaleString('es-MX', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                html += `<td>${totalLoteFormateado}</td>`;
                html += "</tr>";

                let tinasPorDia = {};
                info.dias.forEach(d => tinasPorDia[d] = 0);

                (data.todo_sobre_ultimo_lote || [])
                    .filter(r => r.lote_fda?.startsWith(lote))
                    .forEach(r => {
                        const dia = r.fecha_hora_guardado?.split(' ')[0];
                        if (tinasPorDia[dia] !== undefined) {
                            tinasPorDia[dia]++;
                        }
                    });
                const totalTinas = data.totales_por_lote.find(t => t.lote === lote)?.total_tinas ?? 0;

                html += `<tr style='font-weight:bold; background:#ffffff;'>
                    <td>N¬∞ de Tinas</td>`;

                info.dias.forEach(dia => {
                    html += `<td>${tinasPorDia[dia] || '‚Äì'}</td>`;
                });

                html += `<td>${totalTinas}</td></tr>`;

                html += "</table><br>";
            }
            const rolUsuario = "{{ rol }}";  // <-- pasa rol al JS
            if (rolUsuario === "admin" && data.todo_sobre_ultimo_lote && data.todo_sobre_ultimo_lote.length > 0) {
                const colorUltimoLote = coloresPastel[Math.floor(Math.random() * coloresPastel.length)];
                const ultimo = data.todo_sobre_ultimo_lote;

                html += "<h3>Todo sobre el √∫ltimo lote</h3>";
                html += `<table border='1' cellpadding='5' cellspacing='0' style='background:${colorUltimoLote}; border-collapse: collapse;'>`;

                const columnas = ["uuid", "id_procesa_app", "sku_tina", "sku_talla", "peso_bruto", "tara", "peso_neto", "lote_fda", "tanque", "fecha_hora_guardado"];
                // Encabezados en orden original del JSON
                html += "<tr style='font-weight:bold; background:#ffffff;'>";
                columnas.forEach(col => {
                    html += `<th>${col}</th>`;
                });
                html += "</tr>";

                // Filas
                ultimo.forEach((fila, idx) => {
                    const filaColor = idx % 2 === 0 ? "rgba(255,255,255,0.6)" : "rgba(255,255,255,0.3)";
                    html += `<tr style="background:${filaColor}">`;
                    columnas.forEach(col => {
                        html += `<td>${fila[col]}</td>`;
                    });
                    html += "</tr>";
                });
                html += "</table><br>";
            }
            contenedor.innerHTML = html;
            // ------------------------------------------------------------------
            // HACER CADA TABLA CLICKEABLE PARA ABRIR EL MODAL
            // ------------------------------------------------------------------
            document.querySelectorAll("table[data-lote]").forEach(tabla => {
                tabla.style.cursor = "pointer";
                tabla.addEventListener("click", () => {
                    const lote = tabla.getAttribute("data-lote");
                    abrirModalLote(lote);
                });
            });

            // ------------------------------------------------------------------
            // FUNCI√ìN PARA ABRIR EL MODAL Y CARGAR DETALLES DEL LOTE (ubicaci√≥n editable)
            // ------------------------------------------------------------------
            function abrirModalLote(lote) {
                const modal = document.getElementById("modalDetallesLote");
                const modalBody = document.getElementById("modalContenidoLote");
                modalBody.innerHTML = "<p>Cargando datos...</p>";
                fetch(`/detalles_lote/${lote}`)
                    .then(res => res.json())
                    .then(data => {
                        if (!data || data.length === 0) {
                            modalBody.innerHTML = "<p>No hay datos para este lote.</p>";
                            return;
                        }


                        let html = `
                            <button onclick="copiarTablaPortapapeles()" 
                                    style="margin-bottom:10px; padding:6px 12px; cursor:pointer;">
                                üìã Copiar todo
                            </button>
                        `;
                        html += "<table id='tablaLote' border='1' cellpadding='5' cellspacing='0' style='width:100%; border-collapse: collapse;'>";
                        html += "<thead><tr>";

                        const ordenColumnas = [
                            "fecha_de_descarga",
                            "sku_tina",
                            "sku_talla",
                            "tanque",
                            "peso_bruto",
                            "tara",
                            "peso_neto",
                            "ubicacion",
                            "observaciones",
                            "hora_de_marbete",
                            "hora_de_pesado",
                            "fda",
                            "lote_fda",
                            "lote_sap",
                            "fecha_hora_guardado",
                        ];

                        ordenColumnas.forEach(col => {
                            html += `<th>${col}</th>`;
                        });
                        html += "</tr></thead><tbody>";
                        data.forEach(row => {
                            html += "<tr>";

                            ordenColumnas.forEach(col => {
                                if (col === "ubicacion") {
                                    html += `
                            <td>
                                <input
                                    type="text"
                                    value="${row[col] ?? ''}"
                                    data-id="${row.uuid}"
                                    data-campo="ubicacion"
                                    onblur="guardarCampoEditable(this)"
                                    oninput="this.value = this.value.toUpperCase();"
                                    onkeydown="if (event.key === 'Enter') { event.preventDefault(); this.blur(); }"
                                    style="width:90%;"
                                >
                            </td>
                        `;
                                } else {
                                    html += `<td>${row[col] ?? ''}</td>`;
                                }
                            });

                            html += "</tr>";
                        });
                        html += "</tbody></table>";
                        modalBody.innerHTML = html;
                    })
                    .catch(err => {
                        modalBody.innerHTML = "<p>Error cargando datos.</p>";
                        console.error(err);
                    });

                modal.style.display = "flex";
            }
        })
        .catch(err => console.error("Error cargando datos:", err));

    function cerrarModal() {
        document.getElementById("modalDetallesLote").style.display = "none";
    }



    //--------------------[Guardar campo editable]---------------------
    function guardarCampoEditable(input) {
        const id = input.dataset.id;
        const campo = input.dataset.campo;
        const valor = input.value;

        fetch('/actualizar_campo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id, campo, valor })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    input.style.backgroundColor = "#87ff87";
                    setTimeout(() => {
                        input.style.backgroundColor = "white";
                    }, 2000);
                } else {
                    console.log("error en la respuesta: " + data.message);
                    input.style.backgroundColor = "#ff9494";
                    setTimeout(() => {
                        input.style.backgroundColor = "white";
                    }, 2000);
                }
            })
            .catch(error => {
                console.error("error en la peticion:", error);
                alert("Error al conectar con el servidor");
                input.style.backgroundColor = "#ffeaea"; // Rosa error
                setTimeout(() => {
                    input.style.backgroundColor = "white";
                }, 2000);
            });
    }
    //---------------------[Copiar tabla al portapapeles]---------------------
    function copiarTablaPortapapeles() {
        const tabla = document.getElementById("tablaLote");
        if (!tabla) return;

        let texto = "";

        // Encabezados
        const headers = tabla.querySelectorAll("thead th");
        texto += Array.from(headers).map(th => th.innerText).join("\t") + "\n";

        // Filas
        const filas = tabla.querySelectorAll("tbody tr");
        filas.forEach(fila => {
            const celdas = fila.querySelectorAll("td");
            const valores = Array.from(celdas).map(td => {
                const input = td.querySelector("input");
                return input ? input.value : td.innerText;
            });
            texto += valores.join("\t") + "\n";
        });

        navigator.clipboard.writeText(texto)
            .then(() => {
                alert("üìã Tabla copiada al portapapeles");
            })
            .catch(err => {
                console.error("Error al copiar:", err);
                alert("‚ùå No se pudo copiar");
            });
    }
</script>
{% endblock %}